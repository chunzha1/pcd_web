<!-- Previous code remains the same until the event listener -->

        document.getElementById('input').addEventListener('change', async function(e) {
            try {
                const file = e.target.files[0];
                if (!file) {
                    debug('No file selected');
                    return;
                }

                debug(`File selected: ${file.name} (${file.size} bytes)`);

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const contents = event.target.result;
                        debug(`File loaded successfully, content length: ${contents.length}`);

                        if (file.name.endsWith('.xyz')) {
                            loadXYZ(contents);
                        } else if (file.name.endsWith('.pcd')) {
                            loadPCD(contents);
                        }
                    } catch (error) {
                        debug('Error processing file: ' + error.message);
                    }
                };

                reader.onerror = function(error) {
                    debug('Error reading file: ' + error);
                };

                reader.readAsText(file);
            } catch (error) {
                debug('Error during file selection: ' + error.message);
            }
        });

        function loadXYZ(contents) {
            try {
                const lines = contents.split('\n');
                debug(`Processing XYZ file with ${lines.length} lines`);

                const positions = [];
                let pointCount = 0;

                for (let line of lines) {
                    line = line.trim();
                    if (line === '') continue;
                    
                    const values = line.split(/\s+/);
                    if (values.length >= 3) {
                        const [x, y, z] = values.map(Number);
                        if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                            positions.push(x, y, z);
                            pointCount++;
                        }
                    }
                }

                debug(`Found ${pointCount} valid points`);
                if (positions.length > 0) {
                    createPointCloud(positions);
                } else {
                    debug('No valid points found in file');
                }
            } catch (error) {
                debug('Error loading XYZ file: ' + error.message);
            }
        }

        function loadPCD(contents) {
            try {
                const lines = contents.split('\n');
                debug(`Processing PCD file with ${lines.length} lines`);

                const positions = [];
                let readingData = false;
                let headerProcessed = false;
                let expectedPoints = 0;
                let pointCount = 0;

                for (let line of lines) {
                    line = line.trim();
                    if (line === '') continue;

                    if (!headerProcessed) {
                        if (line.startsWith('POINTS')) {
                            expectedPoints = parseInt(line.split(' ')[1]);
                            debug(`Expected points from header: ${expectedPoints}`);
                        }
                        if (line === 'DATA ascii') {
                            readingData = true;
                            headerProcessed = true;
                            debug('Found DATA ascii marker, starting to read points');
                        }
                        continue;
                    }

                    if (readingData) {
                        const values = line.split(/\s+/);
                        if (values.length >= 3) {
                            const [x, y, z] = values.map(Number);
                            if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                                positions.push(x, y, z);
                                pointCount++;
                            }
                        }
                    }
                }

                debug(`Found ${pointCount} valid points`);
                if (positions.length > 0) {
                    createPointCloud(positions);
                } else {
                    debug('No valid points found in file');
                }
            } catch (error) {
                debug('Error loading PCD file: ' + error.message);
            }
        }

        function createPointCloud(positions) {
            try {
                debug(`Creating point cloud with ${positions.length / 3} points`);

                if (points) {
                    scene.remove(points);
                    debug('Removed existing point cloud');
                }

                const geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));

                const material = new THREE.PointsMaterial({
                    size: pointSize,
                    sizeAttenuation: true,
                    color: 0x00ff00,
                    transparent: true,
                    opacity: 0.8
                });

                points = new THREE.Points(geometry, material);
                scene.add(points);

                // 更新点数显示
                document.getElementById('point-count').textContent = positions.length / 3;

                debug('Point cloud created and added to scene');

                // 重置变换
                resetTransform();
                // 重置相机位置以适应点云
                resetCamera();
            } catch (error) {
                debug('Error creating point cloud: ' + error.message);
            }
        }

        // 初始化场景
        init();
    </script>
</body>
</html>
